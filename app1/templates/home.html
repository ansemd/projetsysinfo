<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransportPro</title>
</head>
<body>
    <style>
        /* Style pour le menu utilisateur */
        .user-menu {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 1000;
        }
        
        .user-icon {
            background: #667eea;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: background 0.3s;
        }
        
        .user-icon:hover {
            background: #5568d3;
        }
        
        .user-dropdown {
            display: none;
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 250px;
            overflow: hidden;
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .user-info {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        
        .user-info strong {
            display: block;
            font-size: 16px;
            color: #333;
        }
        
        .user-info small {
            color: #666;
            font-size: 12px;
        }
        
        .dropdown-item {
            padding: 12px 15px;
            display: block;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item.danger {
            color: #dc3545;
        }
        
        .dropdown-item.success {
            color: #28a745;
        }
    </style>
    
    <!-- Menu utilisateur -->
    <div class="user-menu">
        <div class="user-icon" onclick="toggleUserMenu()">
            üë§
        </div>
        
        <div class="user-dropdown" id="userDropdown">
            <div class="user-info">
                <strong>{{ request.user.first_name }} {{ request.user.last_name }}</strong>
                <small>@{{ request.user.username }}</small>
                {% if request.user.is_responsable %}
                <small style="display: block; color: #28a745; margin-top: 5px;">
                    ‚≠ê Agent Responsable
                </small>
                {% endif %}
            </div>
            
            {% if request.user.is_responsable %}
            <!-- Options pour l'agent responsable uniquement -->
            <a href="{% url 'ajouter_agent' %}" class="dropdown-item success">
                ‚ûï Ajouter un agent
            </a>
            <a href="{% url 'liste_agents' %}" class="dropdown-item">
                üë• Liste des agents
            </a>
            {% endif %}
            
            <!-- Options pour tous les agents -->
            <a href="{% url 'changer_mot_de_passe' %}" class="dropdown-item">
                üîê Changer le mot de passe
            </a>
            <a href="{% url 'logout' %}" class="dropdown-item danger">
                üö™ D√©connexion
            </a>
        </div>
    </div>
    
    <script>
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }
        
        // Fermer le menu si on clique ailleurs
        window.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('userDropdown').classList.remove('show');
            }
        });
    </script>
    
    <h1>TransportPro</h1>
    
    <!-- ========== MESSAGES ========== -->
    {% if messages %}
        {% for message in messages %}
            <p><strong>{{ message }}</strong></p>
        {% endfor %}
    {% endif %}
    
    <hr>
    
    
    <!-- ========== SECTION FAVORIS ========== -->
    <section>
        <h2>Mes Favoris</h2>
        <p>
            <a href="{% url 'selectionner_favoris' %}">+ S√©lectionner vos favoris</a>
        </p>
        
        {% if favoris %}
            <div>
                {% for fav in favoris %}
                    <div style="display: inline-block; border: 1px solid #ccc; padding: 10px; margin: 5px;">
                        <strong>{{ fav.icone }}</strong><br>
                        <a href="{% url fav.url %}">{{ fav.nom }}</a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>Aucun favori s√©lectionn√©. <a href="{% url 'selectionner_favoris' %}">Cliquez ici pour en choisir</a>.</p>
        {% endif %}
    </section>
    
    <hr>
    
    <!-- ========== SECTION NOTIFICATIONS ========== -->
    <aside style="border: 2px solid orange; padding: 15px; background-color: #fffbe6; margin-bottom: 20px;">
        <h2>üîî Notifications</h2>
        
        {% if notifications %}
            <p><strong>{{ notifications|length }} notification(s) non lue(s)</strong></p>
            
            <ul style="list-style: none; padding: 0;">
                {% for notif in notifications %}
                <li style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; background-color: white; border-radius: 5px;">
                    <!-- En-t√™te -->
                    <div style="margin-bottom: 10px;">
                        <strong style="font-size: 14px; color: #333;">{{ notif.get_type_notification_display }}</strong><br>
                        <span style="font-size: 16px; font-weight: bold;">{{ notif.titre }}</span><br>
                        <small style="color: #666;">{{ notif.date_creation|date:"d/m/Y H:i" }}</small>
                    </div>
                    
                    <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">
                    
                    <!-- Message -->
                    <div style="margin: 10px 0; padding: 10px; background-color: #f9f9f9; border-left: 3px solid orange;">
                        <p style="white-space: pre-line; margin: 0; font-size: 14px;">{{ notif.message }}</p>
                    </div>
                    
                    <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">
                    
                    <!-- Boutons d'action -->
                    <div style="margin-top: 10px;">
                        {% if notif.type_notification == 'SOLDE_NEGATIF' %}
                            <form method="post" action="{% url 'traiter_notification' notif.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" name="action" value="OK" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;">
                                    ‚úÖ OK - Rembourser le client
                                </button>
                            </form>
                        
                        {% elif notif.type_notification == 'MAINTENANCE_AVANT' %}
                            <form method="post" action="{% url 'traiter_notification' notif.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" name="action" value="OK" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; margin-right: 10px;">
                                    ‚úÖ OK - Confirmer maintenance
                                </button>
                                <button type="submit" name="action" value="REPORTER" style="padding: 10px 20px; background-color: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;">
                                    ‚è≠Ô∏è Reporter la maintenance
                                </button>
                            </form>
                        
                        {% elif notif.type_notification == 'MAINTENANCE_APRES' %}
                            <form method="post" action="{% url 'traiter_notification' notif.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" name="action" value="OUI" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; margin-right: 10px;">
                                    ‚úÖ OUI - V√©hicule revenu
                                </button>
                                <button type="submit" name="action" value="NON" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;">
                                    ‚ùå NON - Pas encore
                                </button>
                            </form>
                        
                        {% elif notif.type_notification == 'REMBOURSEMENT_REQUIS' %}
                            <form method="post" action="{% url 'traiter_notification' notif.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" name="action" value="OK" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;">
                                    ‚úÖ OK - Effectuer le remboursement
                                </button>
                            </form>

                        {% elif notif.type_notification == 'TOURNEE_TERMINEE' %}
                            <form method="post" action="{% url 'traiter_notification' notif.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" name="action" value="OK" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;">
                                    ‚úÖ OK - Renseigner le kilom√©trage
                                </button>
                            </form>
                        <!-- INCIDENT CR√â√â (pour agent responsable) -->
                        {% elif notif.type_notification == 'INCIDENT_CREE' %}
                        <div style="border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 15px; background: #fff;">
                            <strong>üö® {{ notif.titre }}</strong>
                            <p>{{ notif.message }}</p>
                            <div style="background: #fff3cd; padding: 10px; margin: 10px 0;">
                                <p><strong>Incident :</strong> {{ notif.incident.numero_incident }}</p>
                                <p><strong>Type :</strong> {{ notif.incident.get_type_incident_display }}</p>
                                <p><strong>S√©v√©rit√© :</strong> {{ notif.incident.severite }}</p>
                            </div>
                            <form method="POST" action="{% url 'traiter_notification' notif.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" name="action" value="AFFECTER" class="btn-primary">
                                    üìå Affecter √† un agent
                                </button>
                            </form>
                        </div>

                        <!-- INCIDENT AFFECT√â (pour agent affect√©) -->
                        {% elif notif.type_notification == 'INCIDENT_AFFECTE' %}
                        <div style="border-left: 4px solid #dc3545; padding: 15px; margin-bottom: 15px; background: #fff;">
                            <strong>üìå {{ notif.titre }}</strong>
                            <p>{{ notif.message }}</p>
                            <div style="background: #f8d7da; padding: 10px; margin: 10px 0;">
                                <p><strong>Incident :</strong> {{ notif.incident.numero_incident }}</p>
                                <p><strong>Type :</strong> {{ notif.incident.get_type_incident_display }}</p>
                                <p><strong>S√©v√©rit√© :</strong> 
                                    <span class="badge badge-{% if notif.incident.severite == 'CRITIQUE' %}danger{% elif notif.incident.severite == 'ELEVEE' %}warning{% else %}info{% endif %}">
                                        {{ notif.incident.get_severite_display }}
                                    </span>
                                </p>
                            </div>
                            
                            <form method="POST" action="{% url 'traiter_notification' notif.id %}">
                                {% csrf_token %}
                                <button type="submit" name="action" value="VOIR" class="btn-primary">
                                    üëÅÔ∏è Voir l'incident
                                </button>
                            </form>
                        </div>
                        <!-- R√âCLAMATION CR√â√âE (pour agent responsable) -->
                        {% elif notif.type_notification == 'RECLAMATION_CREEE' %}
                        <div style="border-left: 4px solid #17a2b8; padding: 15px; margin-bottom: 15px; background: #fff;">
                            <strong>üìù {{ notif.titre }}</strong>
                            <p>{{ notif.message }}</p>
                            <div style="background: #d1ecf1; padding: 10px; margin: 10px 0;">
                                <p><strong>R√©clamation :</strong> {{ notif.reclamation.numero_reclamation }}</p>
                                <p><strong>Nature :</strong> {{ notif.reclamation.get_nature_display }}</p>
                                <p><strong>Priorit√© :</strong> {{ notif.reclamation.get_priorite_display }}</p>
                            </div>
                            <form method="POST" action="{% url 'traiter_notification' notif.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" name="action" value="AFFECTER" class="btn-primary">
                                    üìå Affecter √† un agent
                                </button>
                            </form>
                        </div>

                        <!-- R√âCLAMATION AFFECT√âE (pour agent affect√©) -->
                        {% elif notif.type_notification == 'RECLAMATION_AFFECTEE' %}
                        <div style="border-left: 4px solid #28a745; padding: 15px; margin-bottom: 15px; background: #fff;">
                            <strong>‚úÖ {{ notif.titre }}</strong>
                            <p>{{ notif.message }}</p>
                            <div style="background: #d4edda; padding: 10px; margin: 10px 0;">
                                <p><strong>R√©clamation :</strong> {{ notif.reclamation.numero_reclamation }}</p>
                                <p><strong>Nature :</strong> {{ notif.reclamation.get_nature_display }}</p>
                                <p><strong>Priorit√© :</strong> 
                                    <span class="badge badge-{% if notif.reclamation.priorite == 'URGENTE' %}danger{% elif notif.reclamation.priorite == 'HAUTE' %}warning{% else %}info{% endif %}">
                                        {{ notif.reclamation.get_priorite_display }}
                                    </span>
                                </p>
                            </div>
                            <form method="POST" action="{% url 'traiter_notification' notif.id %}">
                                {% csrf_token %}
                                <button type="submit" name="action" value="VOIR" class="btn-primary">
                                    üëÅÔ∏è Voir la r√©clamation
                                </button>
                            </form>
                        </div>
                        <!-- INCIDENT R√âSOLU (pour agent responsable) -->
                        {% elif notif.type_notification == 'INCIDENT_RESOLU' %}
                        <div style="border-left: 4px solid #28a745; padding: 15px; margin-bottom: 15px; background: #fff;">
                            <strong>‚úÖ {{ notif.titre }}</strong>
                            <p>{{ notif.message }}</p>
                            <div style="background: #d4edda; padding: 10px; margin: 10px 0;">
                                <p><strong>Incident :</strong> {{ notif.incident.numero_incident }}</p>
                                <p><strong>Type :</strong> {{ notif.incident.get_type_incident_display }}</p>
                                <p><strong>Statut :</strong> {{ notif.incident.get_statut_display }}</p>
                            </div>
                            <form method="POST" action="{% url 'traiter_notification' notif.id %}">
                                {% csrf_token %}
                                <button type="submit" name="action" value="CLOTURER" class="btn-success">
                                    ‚úÖ Voir et cl√¥turer
                                </button>
                            </form>
                        </div>

                        <!-- R√âCLAMATION R√âSOLUE (pour agent responsable) -->
                        {% elif notif.type_notification == 'RECLAMATION_RESOLUE' %}
                        <div style="border-left: 4px solid #28a745; padding: 15px; margin-bottom: 15px; background: #fff;">
                            <strong>‚úÖ {{ notif.titre }}</strong>
                            <p>{{ notif.message }}</p>
                            <div style="background: #d4edda; padding: 10px; margin: 10px 0;">
                                <p><strong>R√©clamation :</strong> {{ notif.reclamation.numero_reclamation }}</p>
                                <p><strong>Nature :</strong> {{ notif.reclamation.get_nature_display }}</p>
                                <p><strong>Statut :</strong> {{ notif.reclamation.get_statut_display }}</p>
                            </div>
                            <form method="POST" action="{% url 'traiter_notification' notif.id %}">
                                {% csrf_token %}
                                <button type="submit" name="action" value="CLOTURER" class="btn-success">
                                    ‚úÖ Voir et cl√¥turer
                                </button>
                            </form>
                        </div>
        
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
            
            <p style="margin-top: 15px;">
                <a href="{% url 'liste_notifications' %}" style="color: blue; text-decoration: underline;">
                    Voir toutes les notifications
                </a>
            </p>
        {% else %}
            <p style="font-size: 16px;">‚úÖ Aucune notification</p>
        {% endif %}
    </aside>
    
    <hr>
    <!-- ========== R√âCLAMATIONS NON TERMIN√âES ========== -->
    <section>
        <h2>üìù R√©clamations en cours</h2>

        {% if reclamations_non_terminees %}
            <ul style="list-style: none; padding: 0;">
                {% for rec in reclamations_non_terminees %}
                <li style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #fffbe6;">
                    <strong>{{ rec.numero_reclamation }} - {{ rec.get_type_reclamation_display }}</strong><br>
                    <span>Priorit√© : {{ rec.get_priorite_display }}</span><br>
                    <span>Statut : {{ rec.get_statut_display }}</span><br>
                    <a href="{% url 'detail_reclamation' rec.id %}" style="color: blue; text-decoration: underline;">Voir la r√©clamation</a>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Aucune r√©clamation non termin√©e</p>
        {% endif %}
    </section>

    <hr>

    <!-- ========== INCIDENTS NON TERMIN√âS ========== -->
    <section>
        <h2>üö® Incidents en cours</h2>

        {% if incidents_non_termines %}
            <ul style="list-style: none; padding: 0;">
                {% for inc in incidents_non_termines %}
                <li style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #fff3cd;">
                    <strong>{{ inc.numero_incident }} - {{ inc.get_type_incident_display }}</strong><br>
                    <span>S√©v√©rit√© : {{ inc.severite }}</span><br>
                    <span>Statut : {{ inc.get_statut_display }}</span><br>
                    <a href="{% url 'detail_incident' inc.id %}" style="color: blue; text-decoration: underline;">Voir l'incident</a>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Aucun incident non termin√©</p>
        {% endif %}
    </section>
    <!-- ========== TOURN√âES EN COURS ========== -->
    <section>
        <h2>üöö Tourn√©es en cours</h2>
        
        {% if tournees_en_cours %}
            <table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">
                <thead style="background-color: #f0f0f0;">
                    <tr>
                        <th>ID</th>
                        <th>Chauffeur</th>
                        <th>V√©hicule</th>
                        <th>Date d√©part</th>
                        <th>Zone</th>
                        <th>Nb exp√©ditions</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tournee in tournees_en_cours %}
                    <tr>
                        <td>{{ tournee.id }}</td>
                        <td>{{ tournee.chauffeur.prenom }} {{ tournee.chauffeur.nom }}</td>
                        <td>{{ tournee.vehicule.numero_immatriculation }}</td>
                        <td>{{ tournee.date_depart|date:"d/m/Y H:i" }}</td>
                        <td>{{ tournee.get_zone_cible_display }}</td>
                        <td>{{ tournee.nb_expeditions }}</td>
                        <td>
                            <form method="post" action="{% url 'modifier_statut_tournee' tournee.id %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="source" value="home">
                                <select name="statut" onchange="this.form.submit()">
                                    {% for code, nom in statuts_tournee %}
                                    <option value="{{ code }}" {% if tournee.statut == code %}selected{% endif %}>
                                        {{ nom }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>
                        <td>
                            <a href="{% url 'detail_tournee' tournee.id %}">D√©tails</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Aucune tourn√©e en cours</p>
        {% endif %}
    </section>
    
    <hr>
    
    <!-- ========== TOURN√âES PR√âVUES DEMAIN ========== -->
    <section>
        <h2>üìÖ Tourn√©es pr√©vues demain</h2>
        
        {% if tournees_demain %}
            <table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">
                <thead style="background-color: #f0f0f0;">
                    <tr>
                        <th>ID</th>
                        <th>Chauffeur</th>
                        <th>V√©hicule</th>
                        <th>Heure d√©part</th>
                        <th>Zone</th>
                        <th>Nb exp√©ditions</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tournee in tournees_demain %}
                    <tr>
                        <td>{{ tournee.id }}</td>
                        <td>{{ tournee.chauffeur.prenom }} {{ tournee.chauffeur.nom }}</td>
                        <td>{{ tournee.vehicule.numero_immatriculation }}</td>
                        <td>{{ tournee.date_depart|date:"H:i" }}</td>
                        <td>{{ tournee.get_zone_cible_display }}</td>
                        <td>{{ tournee.nb_expeditions }}</td>
                        <td>
                            <form method="post" action="{% url 'modifier_statut_tournee' tournee.id %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="source" value="home">
                                <select name="statut" onchange="this.form.submit()">
                                    {% for code, nom in statuts_tournee %}
                                    <option value="{{ code }}" {% if tournee.statut == code %}selected{% endif %}>
                                        {{ nom }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>
                        <td>
                            <a href="{% url 'detail_tournee' tournee.id %}">D√©tails</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Aucune tourn√©e pr√©vue demain</p>
        {% endif %}
    </section>
    
    <hr>
    
    <p><a href="{% url 'liste_tournees' %}">‚Üí Voir toutes les tourn√©es</a></p>
    
</body>
</html>