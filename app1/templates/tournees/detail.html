<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>D√©tails Tourn√©e #{{ tournee.id }}</title>
</head>
<body>
    <h1>D√©tails de la Tourn√©e #{{ tournee.id }}</h1>
    
    <a href="{% url 'liste_tournees' %}"><button>‚Üê Retour √† la liste</button></a>
    {% if tournee.statut == 'PREVUE' %}
        <a href="{% url 'modifier_tournee' tournee.id %}"><button>Modifier</button></a>
        <a href="{% url 'supprimer_tournee' tournee.id %}"><button>Supprimer</button></a>
    {% endif %}
    {% if tournee.statut == 'EN_COURS' %}
        <a href="{% url 'terminer_tournee' tournee.id %}"><button style="background: green; color: white;">‚úÖ Terminer la tourn√©e</button></a>
    {% endif %}
    <a href="{% url 'exporter_tournee_detail_pdf' tournee.id %}"><button style="background: #dc3545; color: white;">üìÑ Exporter PDF</button></a>
    
    <hr>
    
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <p style="color: green;"><strong>{{ message }}</strong></p>
        {% endfor %}
    {% endif %}
    
    <!-- Informations de la tourn√©e -->
    <h2>Informations de la Tourn√©e</h2>
    <table border="1" cellpadding="10">
        <tr>
            <th>Chauffeur</th>
            <td>{{ tournee.chauffeur.prenom }} {{ tournee.chauffeur.nom }} ({{ tournee.chauffeur.get_id_chauffeur }})</td>
        </tr>
        <tr>
            <th>V√©hicule</th>
            <td>{{ tournee.vehicule.marque }} {{ tournee.vehicule.modele }} - {{ tournee.vehicule.numero_immatriculation }}</td>
        </tr>
        <tr>
            <th>Date de d√©part</th>
            <td>{{ tournee.date_depart|date:"d/m/Y √† H:i" }}</td>
        </tr>
        <tr>
            <th>Date de retour pr√©vue</th>
            <td>{{ tournee.date_retour_prevue|date:"d/m/Y √† H:i" }}</td>
        </tr>
        {% if tournee.date_retour_reelle %}
        <tr>
            <th>Date de retour r√©elle</th>
            <td>{{ tournee.date_retour_reelle|date:"d/m/Y √† H:i" }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Zone cible</th>
            <td>{{ tournee.get_zone_cible_display }}</td>
        </tr>
        <tr>
            <th>Statut</th>
            <td>
                {% if tournee.statut == 'PREVUE' %}
                    <span style="color: blue;">‚è±Ô∏è {{ tournee.get_statut_display }}</span>
                {% elif tournee.statut == 'EN_COURS' %}
                    <span style="color: orange;">üöö {{ tournee.get_statut_display }}</span>
                {% else %}
                    <span style="color: green;">‚úÖ {{ tournee.get_statut_display }}</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Tourn√©e priv√©e (EXPRESS)</th>
            <td>{{ tournee.est_privee|yesno:"Oui,Non" }}</td>
        </tr>
        {% if tournee.kilometrage_depart %}
        <tr>
            <th>Kilom√©trage d√©part</th>
            <td>{{ tournee.kilometrage_depart }} km</td>
        </tr>
        {% endif %}
        {% if tournee.kilometrage_arrivee %}
        <tr>
            <th>Kilom√©trage arriv√©e</th>
            <td>{{ tournee.kilometrage_arrivee }} km</td>
        </tr>
        {% endif %}
        {% if tournee.kilometrage_parcouru %}
        <tr>
            <th>Kilom√©trage parcouru</th>
            <td><strong>{{ tournee.kilometrage_parcouru }} km</strong></td>
        </tr>
        {% endif %}
        {% if tournee.consommation_carburant %}
        <tr>
            <th>Consommation carburant</th>
            <td>{{ tournee.consommation_carburant|floatformat:2 }} L</td>
        </tr>
        {% endif %}
        <tr>
            <th>Date de cr√©ation</th>
            <td>{{ tournee.date_creation|date:"d/m/Y H:i" }}</td>
        </tr>
        {% if tournee.remarques %}
        <tr>
            <th>Remarques</th>
            <td>{{ tournee.remarques }}</td>
        </tr>
        {% endif %}
        <h3>üìã Tra√ßabilit√©</h3>
            <table border="1" cellpadding="10" style="margin-top: 10px;">
                <tr>
                    <th>Cr√©√© par :</th>
                    <td>
                        {% if tournee.cree_par %}
                            {{ tournee.cree_par.first_name }} {{ tournee.cree_par.last_name }}
                            <small>(@{{ tournee.cree_par.username }})</small>
                        {% else %}
                            <em style="color: #999;">Non renseign√©</em>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Date de cr√©ation :</th>
                    <td>{{ tournee.date_creation|date:"d/m/Y √† H:i" }}</td>
                </tr>
                {% if tournee.modifie_par %}
                <tr>
                    <th>Derni√®re modification par :</th>
                    <td>
                        {{ tournee.modifie_par.first_name }} {{ tournee.modifie_par.last_name }}
                        <small>(@{{ tournee.modifie_par.username }})</small>
                    </td>
                </tr>
                <tr>
                    <th>Date de modification :</th>
                    <td>{{ tournee.date_modification|date:"d/m/Y √† H:i" }}</td>
                </tr>
                {% endif %}
            </table>
    </table>
    
    <hr>
    
    <!-- Liste des exp√©ditions affect√©es -->
    <h2>Exp√©ditions affect√©es ({{ stats_expeditions.total }})</h2>
    
    {% if stats_expeditions.total > 0 %}
    <p><strong>En attente :</strong> {{ stats_expeditions.en_attente }}</p>
    <p><strong>En transit :</strong> {{ stats_expeditions.en_transit }}</p>
    <p><strong>Livr√©es :</strong> {{ stats_expeditions.livrees }}</p>
    
    <table border="1" cellpadding="10" style="margin-top: 20px;">
        <thead>
            <tr>
                <th>N¬∞ Exp√©dition</th>
                <th>Client</th>
                <th>Destination</th>
                <th>Type Service</th>
                <th>Poids</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in expeditions %}
            <tr>
                <td><strong>{{ exp.get_numero_expedition }}</strong></td>
                <td>{{ exp.client.prenom }} {{ exp.client.nom }}</td>
                <td>{{ exp.destination.ville }} - {{ exp.destination.wilaya }}</td>
                <td>{{ exp.type_service.get_type_service_display }}</td>
                <td>{{ exp.poids }} kg</td>
                <td>
                    {% if exp.statut == 'EN_ATTENTE' %}
                        <span style="color: blue;">‚è±Ô∏è {{ exp.get_statut_display }}</span>
                    {% elif exp.statut == 'EN_TRANSIT' %}
                        <span style="color: orange;">üöö {{ exp.get_statut_display }}</span>
                    {% elif exp.statut == 'LIVRE' %}
                        <span style="color: green;">‚úÖ {{ exp.get_statut_display }}</span>
                    {% else %}
                        <span style="color: red;">‚ùå {{ exp.get_statut_display }}</span>
                    {% endif %}
                </td>
                <td><a href="{% url 'detail_expedition' exp.id %}"><button>üëÅÔ∏è Voir</button></a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: orange;">‚ö†Ô∏è Aucune exp√©dition affect√©e √† cette tourn√©e</p>
    {% endif %}
    
</body>
</html>