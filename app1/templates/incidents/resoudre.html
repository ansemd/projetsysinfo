<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Incident {{ incident.numero_incident }}</title>
</head>
<body>
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    
    <h1>‚úÖ R√©soudre l'Incident {{ incident.numero_incident }}</h1>
    
    <a href="{% url 'detail_incident' incident.id %}" style="display: inline-block; margin-bottom: 20px;">
        ‚Üê Retour aux d√©tails
    </a>
    
    <hr>
    
    <!-- INFORMATIONS DE L'INCIDENT -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h2>üìã Informations de l'incident</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <th style="text-align: left; padding: 10px; width: 30%;">Titre :</th>
                <td style="padding: 10px;">{{ incident.titre }}</td>
            </tr>
            <tr>
                <th style="text-align: left; padding: 10px;">Description :</th>
                <td style="padding: 10px;">{{ incident.description }}</td>
            </tr>
            <tr>
                <th style="text-align: left; padding: 10px;">Type :</th>
                <td style="padding: 10px;"><strong>{{ incident.get_type_incident_display }}</strong></td>
            </tr>
            <tr>
                <th style="text-align: left; padding: 10px;">S√©v√©rit√© :</th>
                <td style="padding: 10px;">{{ incident.get_severite_display }}</td>
            </tr>
        </table>
    </div>
    
    <!-- EXP√âDITION CONCERN√âE -->
    <div style="background: #e7f3ff; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h2>üì¶ Exp√©dition concern√©e</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <th style="text-align: left; padding: 10px; width: 30%;">N¬∞ Exp√©dition :</th>
                <td style="padding: 10px;"><strong>{{ expedition.get_numero_expedition }}</strong></td>
            </tr>
            <tr>
                <th style="text-align: left; padding: 10px;">Client :</th>
                <td style="padding: 10px;">{{ expedition.client.prenom }} {{ expedition.client.nom }}</td>
            </tr>
            <tr>
                <th style="text-align: left; padding: 10px;">Destination :</th>
                <td style="padding: 10px;">{{ expedition.destination.ville }}, {{ expedition.destination.wilaya }}</td>
            </tr>
            <tr>
                <th style="text-align: left; padding: 10px;">Statut actuel :</th>
                <td style="padding: 10px;"><strong>{{ expedition.get_statut_display }}</strong></td>
            </tr>
            <tr>
                <th style="text-align: left; padding: 10px;">Tourn√©e :</th>
                <td style="padding: 10px;">
                    {% if expedition.tournee %}
                        {{ expedition.tournee.get_numero_tournee }} 
                        (Statut: {{ expedition.tournee.get_statut_display }})
                    {% else %}
                        <em>Pas encore affect√©e √† une tourn√©e</em>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>
    
    <!-- REMBOURSEMENT -->
    {% if taux > 0 %}
    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h2>üí∞ Remboursement</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <th style="text-align: left; padding: 10px; width: 30%;">Montant original TTC :</th>
                <td style="padding: 10px;"><strong>{{ montant_ttc|floatformat:2 }} DA</strong></td>
            </tr>
            <tr>
                <th style="text-align: left; padding: 10px;">Taux de remboursement :</th>
                <td style="padding: 10px;"><strong>{{ taux }}%</strong></td>
            </tr>
            <tr>
                <th style="text-align: left; padding: 10px;">Montant √† rembourser :</th>
                <td style="padding: 10px; color: #d9534f;"><strong>{{ montant_rembourse|floatformat:2 }} DA</strong></td>
            </tr>
        </table>
        <p style="margin-top: 15px; color: #856404;">
            ‚ÑπÔ∏è Une notification de remboursement sera cr√©√©e apr√®s r√©solution de l'incident.
        </p>
    </div>
    {% endif %}
    
    <!-- FORMULAIRE DE R√âSOLUTION -->
    <div style="background: #fff; padding: 20px; border: 2px solid #28a745; border-radius: 8px;">
        <h2>‚úÖ R√©soudre l'incident</h2>
        
        <form method="POST">
            {% csrf_token %}
            
            <!-- CAUSE -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                    Cause de l'incident * :
                </label>
                {% if cause_auto %}
                    <input type="text" value="{{ cause_auto }}" readonly 
                           style="width: 100%; padding: 10px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px;">
                    <small style="color: #6c757d;">Cette cause a √©t√© d√©termin√©e automatiquement</small>
                {% else %}
                    <textarea name="cause" rows="3" required 
                              style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px;"
                              placeholder="D√©crivez la cause de l'incident..."></textarea>
                {% endif %}
            </div>
            
            <!-- STATUT EXP√âDITION -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                    Statut de l'exp√©dition * :
                </label>
                {% if statut_auto %}
                    <input type="text" value="{{ options_statut.0.1 }}" readonly 
                           style="width: 100%; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;">
                    <small style="color: #721c24;">L'exp√©dition sera automatiquement annul√©e</small>
                {% else %}
                    <select name="nouveau_statut_exp" required 
                            style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px;">
                        {% for value, label in options_statut %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                {% endif %}
            </div>
            
            <!-- SOLUTION -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                    Solution appliqu√©e * :
                </label>
                <textarea name="solution" rows="4" required 
                          style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px;"
                          placeholder="D√©crivez la solution mise en place pour r√©soudre cet incident..."></textarea>
            </div>
            
            <!-- BOUTONS -->
            <div style="margin-top: 30px;">
                <button type="submit" 
                        style="background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                    ‚úÖ Marquer comme r√©solu
                </button>
                <a href="{% url 'detail_incident' incident.id %}" 
                   style="display: inline-block; margin-left: 10px; padding: 12px 30px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;">
                    Annuler
                </a>
            </div>
        </form>
    </div>
    
</div>
</body>
</html>